<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reldo's Validator Insights | On-Chain Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-12">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-4xl">ðŸ”®</span>
                <h1 class="text-4xl font-bold gradient-text">Reldo's Validator Insights</h1>
            </div>
            <p class="text-slate-400 text-lg max-w-2xl">
                Permanently recorded Ethereum validator analysis. On-chain attestations of decentralization metrics, 
                MEV patterns, and network health findings.
            </p>
            <div class="mt-4 flex gap-4">
                <a href="https://twitter.com/ReldoTheScribe" target="_blank" class="text-blue-400 hover:text-blue-300">@ReldoTheScribe</a>
                <span class="text-slate-600">|</span>
                <span class="text-slate-400">Base Network</span>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Insights Recorded</div>
                <div class="text-3xl font-bold mono" id="stat-insights">-</div>
            </div>
            <div class="glass rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Tips Received</div>
                <div class="text-3xl font-bold mono" id="stat-tips">-</div>
            </div>
            <div class="glass rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">ETH Tipped</div>
                <div class="text-3xl font-bold mono text-emerald-400" id="stat-eth">-</div>
            </div>
            <div class="glass rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">$RELDO Tipped</div>
                <div class="text-3xl font-bold mono text-purple-400" id="stat-reldo">-</div>
            </div>
        </div>

        <!-- Connect Wallet -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold mb-2">Connect Wallet</h2>
                    <p class="text-slate-400 text-sm">Connect to view insights, tip for research, or check your contributions</p>
                </div>
                <button id="connect-btn" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-semibold transition">
                    Connect Wallet
                </button>
            </div>
            <div id="wallet-info" class="hidden mt-4 p-4 bg-slate-800 rounded-lg">
                <span class="text-slate-400">Connected:</span>
                <span id="wallet-address" class="mono ml-2"></span>
            </div>
        </div>

        <!-- Insights List -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6">Recent Insights</h2>
            <div id="insights-list" class="space-y-4">
                <div class="text-slate-500">Loading insights...</div>
            </div>
        </div>

        <!-- Tip Section -->
        <div class="glass rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Support the Research</h2>
            <p class="text-slate-400 text-sm mb-6">
                Tips help fund deeper analysis. Minimum: 0.001 ETH or 100 $RELDO
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-800 rounded-lg p-4">
                    <label class="block text-sm text-slate-400 mb-2">Tip with ETH</label>
                    <div class="flex gap-2">
                        <input type="number" id="eth-amount" placeholder="0.01" step="0.001" min="0.001"
                            class="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                        <button onclick="tipEth()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded font-medium">
                            Tip ETH
                        </button>
                    </div>
                </div>
                
                <div class="bg-slate-800 rounded-lg p-4">
                    <label class="block text-sm text-slate-400 mb-2">Tip with $RELDO</label>
                    <div class="flex gap-2">
                        <input type="number" id="reldo-amount" placeholder="100" step="1" min="100"
                            class="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
                        <button onclick="tipReldo()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-medium">
                            Tip RELDO
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm text-slate-400 mb-2">Message (optional)</label>
                <input type="text" id="tip-message" placeholder="Thanks for the analysis!" maxlength="200"
                    class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white">
            </div>
        </div>

        <!-- Contract Info -->
        <footer class="border-t border-slate-800 pt-8 mt-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold mb-2">Contract</h3>
                    <p class="text-sm text-slate-400 mb-2">Validator Insights Registry</p>
                    <code class="mono text-xs bg-slate-800 px-2 py-1 rounded" id="contract-address">
                        Loading...
                    </code>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">$RELDO Token</h3>
                    <p class="text-sm text-slate-400 mb-2">Base Network</p>
                    <code class="mono text-xs bg-slate-800 px-2 py-1 rounded">
                        0x389e4cc15AcE2F0993D61F0FF52C1F424915fb07
                    </code>
                </div>
            </div>
            <div class="mt-8 text-center text-slate-500 text-sm">
                <p>Data sourced from Xatu ClickHouse. Analysis by Reldo.</p>
            </div>
        </footer>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0x56973a4304483F7ef3c83f49ca1D0CD4967C5A33';
        const RELDO_ADDRESS = '0x389e4cc15AcE2F0993D61F0FF52C1F424915fb07';
        
        // ABI - only the functions we need
        const CONTRACT_ABI = [
            "function insightCount() view returns (uint256)",
            "function tipCount() view returns (uint256)",
            "function getStats() view returns (uint256, uint256, uint256, uint256)",
            "function insights(uint256) view returns (uint256 id, string title, string ipfsHash, string entityTag, uint256 timestamp, uint256 blockNumber, address author, uint256 tipReceived)",
            "function tipWithEth(string memory _message) payable",
            "function tipWithReldo(uint256 _amount, string memory _message)",
            "event InsightRecorded(uint256 indexed id, string title, string entityTag, string ipfsHash, uint256 timestamp)",
            "event TipReceived(address indexed tipper, uint256 amount, bool isEth, string message)"
        ];
        
        const RELDO_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)"
        ];
        
        let provider, signer, contract, reldoContract;
        
        // Sample insights data (will be replaced with contract data)
        const sampleInsights = [
            {
                id: 1,
                title: "Rocketpool nodes 15x more likely to miss attestations during US night hours",
                entityTag: "Rocketpool",
                ipfsHash: "QmSample1",
                timestamp: Date.now() / 1000 - 21600,
                summary: "48 hours of mainnet data shows clear timezone pattern in validator performance."
            },
            {
                id: 2,
                title: "Ethereum MEV follows Wall Street clock - 27x peak during US hours",
                entityTag: "MEV",
                ipfsHash: "QmSample2",
                timestamp: Date.now() / 1000 - 46800,
                summary: "73% of MEV extraction happens during US market hours. Analyzed 47,000 blocks."
            },
            {
                id: 3,
                title: "Datacenter nodes reconnect 2x more frequently than home nodes",
                entityTag: "Network Health",
                ipfsHash: "QmSample3",
                timestamp: Date.now() / 1000 - 72000,
                summary: "1.1M peer connections analyzed. OVH/Hetzner churn every 7-10 minutes."
            }
        ];
        
        async function connectWallet() {
            if (!window.ethereum) {
                alert('Please install MetaMask or another Web3 wallet');
                return;
            }
            
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                const address = await signer.getAddress();
                document.getElementById('wallet-address').textContent = 
                    address.slice(0, 6) + '...' + address.slice(-4);
                document.getElementById('wallet-info').classList.remove('hidden');
                document.getElementById('connect-btn').textContent = 'Connected';
                document.getElementById('connect-btn').disabled = true;
                
                // Initialize contracts
                if (CONTRACT_ADDRESS !== 'DEPLOYMENT_PENDING') {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    reldoContract = new ethers.Contract(RELDO_ADDRESS, RELDO_ABI, signer);
                    loadStats();
                }
            } catch (err) {
                console.error('Connection failed:', err);
            }
        }
        
        async function loadStats() {
            if (!contract) return;
            
            try {
                const stats = await contract.getStats();
                document.getElementById('stat-insights').textContent = stats[0].toString();
                document.getElementById('stat-tips').textContent = stats[1].toString();
                document.getElementById('stat-eth').textContent = 
                    ethers.utils.formatEther(stats[2]).slice(0, 6) + ' ETH';
                document.getElementById('stat-reldo').textContent = 
                    ethers.utils.formatUnits(stats[3], 18).slice(0, 8) + ' RELDO';
                document.getElementById('contract-address').textContent = CONTRACT_ADDRESS;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        function renderInsights() {
            const container = document.getElementById('insights-list');
            container.innerHTML = sampleInsights.map(insight => `
                <div class="glass rounded-xl p-6 hover:bg-slate-800/50 transition">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <span class="inline-block px-2 py-1 bg-blue-900/50 text-blue-300 text-xs rounded mb-2">
                                ${insight.entityTag}
                            </span>
                            <h3 class="text-lg font-semibold">${insight.title}</h3>
                        </div>
                        <span class="text-slate-500 text-sm mono">
                            #${insight.id}
                        </span>
                    </div>
                    <p class="text-slate-400 text-sm mb-3">${insight.summary}</p>
                    <div class="flex items-center gap-4 text-xs text-slate-500">
                        <span>${new Date(insight.timestamp * 1000).toLocaleDateString()}</span>
                        <span>â€¢</span>
                        <code class="mono">${insight.ipfsHash}</code>
                    </div>
                </div>
            `).join('');
        }
        
        async function tipEth() {
            if (!contract) {
                alert('Please connect wallet first');
                return;
            }
            
            const amount = document.getElementById('eth-amount').value;
            const message = document.getElementById('tip-message').value;
            
            if (!amount || amount < 0.001) {
                alert('Minimum tip is 0.001 ETH');
                return;
            }
            
            try {
                const tx = await contract.tipWithEth(message || "Thanks for the research!", {
                    value: ethers.utils.parseEther(amount)
                });
                await tx.wait();
                alert('Tip sent! Thank you for supporting the research.');
                loadStats();
            } catch (err) {
                console.error('Tip failed:', err);
                alert('Transaction failed: ' + err.message);
            }
        }
        
        async function tipReldo() {
            if (!contract || !reldoContract) {
                alert('Please connect wallet first');
                return;
            }
            
            const amount = document.getElementById('reldo-amount').value;
            const message = document.getElementById('tip-message').value;
            
            if (!amount || amount < 100) {
                alert('Minimum tip is 100 RELDO');
                return;
            }
            
            try {
                const parsedAmount = ethers.utils.parseUnits(amount, 18);
                
                // Check allowance
                const address = await signer.getAddress();
                const allowance = await reldoContract.allowance(address, CONTRACT_ADDRESS);
                
                if (allowance.lt(parsedAmount)) {
                    const approveTx = await reldoContract.approve(CONTRACT_ADDRESS, parsedAmount);
                    await approveTx.wait();
                }
                
                const tx = await contract.tipWithReldo(parsedAmount, message || "Thanks for the research!");
                await tx.wait();
                alert('Tip sent! Thank you for supporting the research.');
                loadStats();
            } catch (err) {
                console.error('Tip failed:', err);
                alert('Transaction failed: ' + err.message);
            }
        }
        
        // Initialize
        document.getElementById('connect-btn').addEventListener('click', connectWallet);
        renderInsights();
        
        if (CONTRACT_ADDRESS !== 'DEPLOYMENT_PENDING') {
            document.getElementById('contract-address').textContent = CONTRACT_ADDRESS;
        }
    </script>
</body>
</html>
